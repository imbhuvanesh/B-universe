<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B Universe - Group Collaboration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            color: #e2e8f0; /* Lighter text for dark bg */
            background: radial-gradient(ellipse at center, #261433 0%, #110a18 70%, #020003 100%);
        }
        #chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        #chat-messages::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        .scrambling-text {
            display: inline-block;
        }
        .glass-effect {
            background-color: rgba(17, 24, 39, 0.6); /* Semi-transparent dark bg */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-slate-900">

    <!-- Entry Modal -->
    <div id="entry-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="glass-effect rounded-2xl shadow-xl p-8 w-full max-w-md text-center">
            <h2 class="text-2xl font-bold text-white mb-2">B-Universe</h2>
            <p class="text-slate-400 mb-6">Create a temporary name to enter the stream.</p>
            <form id="name-form">
                <input type="text" id="name-input" placeholder="Enter your display name..." class="w-full px-4 py-3 bg-slate-800 border border-slate-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 transition" required>
                <button type="submit" class="w-full bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg mt-4 hover:bg-cyan-700 transition-transform transform hover:scale-105">
                    Enter 
                </button>
            </form>
        </div>
    </div>

    <!-- Main Chat Application -->
    <div id="chat-app" class="hidden w-full h-full sm:max-w-4xl sm:h-[90vh] sm:my-[5vh] mx-auto glass-effect rounded-none sm:rounded-2xl shadow-2xl flex flex-col">
        <!-- Header -->
        <header class="border-b border-slate-700 p-4 flex justify-between items-center flex-shrink-0">
            <div>
                <h1 class="text-xl font-bold text-white">B Universe</h1>
                <p class="text-sm text-slate-400"></p>
            </div>
            <div id="online-status" class="flex items-center space-x-2 bg-green-500/20 text-green-300 text-sm font-medium pl-2 pr-3 py-1 rounded-full">
                <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbm56dnhsaGowbTRscHF4dmdxYmJic2p1dDVpY3c1cWt0enN2cWNiMyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/L12g7V0J62bf2/giphy.gif" alt="Running cat" class="h-6 w-auto invert brightness-200" style="image-rendering: pixelated;">
                <span id="online-count">0 Members Online</span>
            </div>
        </header>

        <!-- Messages Area -->
        <main id="chat-messages" class="flex-1 p-6 overflow-y-auto">
            <!-- Messages will be injected here -->
        </main>

        <!-- Message Input -->
        <footer class="border-t border-slate-700 p-4 flex-shrink-0">
            <form id="message-form" class="flex items-center space-x-3">
                <input type="text" id="message-input" placeholder="Type your message..." class="flex-1 w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-full focus:outline-none focus:ring-2 focus:ring-cyan-500 transition text-white" autocomplete="off" required>
                <button type="submit" class="bg-cyan-600 text-white rounded-full w-12 h-12 flex items-center justify-center hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-offset-2 focus:ring-offset-slate-800 transition-transform transform hover:scale-110">
                    <i class="fa-solid fa-paper-plane text-xl"></i>
                </button>
            </form>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, setDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const entryModal = document.getElementById('entry-modal');
        const nameForm = document.getElementById('name-form');
        const nameInput = document.getElementById('name-input');
        const chatApp = document.getElementById('chat-app');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');
        const onlineCountEl = document.getElementById('online-count');

        // --- Firebase Config (provided by environment) ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" }; // Fallback for local dev
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'b-universe-chat';

        // --- App State ---
        let app;
        let auth;
        let db;
        let currentUser = null;
        let displayName = "Anonymous";

        // --- Utility Functions ---
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()';
        function scrambleText(element, originalText) {
            let iteration = 0;
            const interval = setInterval(() => {
                element.textContent = originalText
                    .split("")
                    .map((letter, index) => {
                        if (index < iteration) {
                            return originalText[index];
                        }
                        return chars[Math.floor(Math.random() * chars.length)];
                    })
                    .join("");

                if (iteration >= originalText.length) {
                    clearInterval(interval);
                }
                iteration += 1 / 3;
            }, 30);
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // --- Main App Logic ---
        async function initApp() {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, (user) => {
                currentUser = user;
            });

            try {
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                if (auth.currentUser) {
                    setupPresence();
                    listenForMessages();
                    listenForOnlineUsers();
                } else {
                     console.error("Authentication completed but no user is available.");
                }
            } catch (error) {
                console.error("Authentication failed:", error);
            }
        }
        
        // --- Presence Management ---
        async function setupPresence() {
            if (!currentUser) return;
            const presenceRef = doc(db, `/artifacts/${appId}/public/data/presence`, currentUser.uid);
            await setDoc(presenceRef, { online: true, name: displayName, timestamp: serverTimestamp() });
            
            window.addEventListener('beforeunload', () => {
                deleteDoc(presenceRef);
            });
        }

        // --- Event Listeners ---
        nameForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = nameInput.value.trim();
            if (name) {
                displayName = name;
                entryModal.classList.add('hidden');
                chatApp.classList.remove('hidden');
                messageInput.focus();
                if(currentUser) {
                    const presenceRef = doc(db, `/artifacts/${appId}/public/data/presence`, currentUser.uid);
                    setDoc(presenceRef, { name: displayName }, { merge: true });
                }
            }
        });

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text && currentUser) {
                messageInput.value = '';
                const tempId = `temp-${Date.now()}`;
                const messageElement = createMessageElement({ id: tempId, data: { senderName: displayName, text: text, userId: currentUser.uid }}, true);
                chatMessages.appendChild(messageElement);
                scrollToBottom();

                const textElement = messageElement.querySelector('.scrambling-text');
                scrambleText(textElement, text);

                setTimeout(async () => {
                     try {
                        await addDoc(collection(db, `/artifacts/${appId}/public/data/messages`), { text, senderName: displayName, userId: currentUser.uid, createdAt: serverTimestamp() });
                    } catch (error) {
                        console.error("Error sending message: ", error);
                        messageInput.value = text; // Restore message on failure
                    }
                }, 1000);
            }
        });

        function createMessageElement(msg, isTemp = false) {
            const messageData = msg.data;
            const isMe = messageData.userId === currentUser?.uid;
            
            const tempElem = document.getElementById(`temp-${msg.id.split('-')[1]}`);
            if(!isTemp && tempElem) tempElem.remove();

            const wrapper = document.createElement('div');
            wrapper.id = isTemp ? msg.id : `msg-${msg.id}`;
            const alignmentClasses = isMe ? ['ml-auto', 'justify-end'] : ['mr-auto', 'justify-start'];
            wrapper.classList.add('flex', 'mb-2', 'max-w-xl', ...alignmentClasses);


            wrapper.innerHTML = `
                <div class="flex items-end ${isMe ? 'flex-row-reverse' : ''} gap-2">
                    <div class="px-4 py-2 rounded-2xl ${isMe ? 'bg-blue-600 text-white rounded-br-none' : 'bg-slate-600 text-slate-100 rounded-bl-none'}">
                        ${!isMe ? `<p class="font-bold text-sm text-cyan-300 mb-1">${messageData.senderName}</p>` : ''}
                        <p class="text-md scrambling-text break-words">${isTemp ? '' : messageData.text}</p>
                    </div>
                </div>
            `;
            return wrapper;
        }

        function listenForMessages() {
            const q = query(collection(db, `/artifacts/${appId}/public/data/messages`), orderBy('createdAt', 'asc'));
            
            onSnapshot(q, (querySnapshot) => {
                querySnapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const messageId = `msg-${change.doc.id}`;
                        if (document.getElementById(messageId)) return;
                        
                        const msg = { id: change.doc.id, data: change.doc.data() };
                        const messageElement = createMessageElement(msg);

                        const isMyMessage = msg.data.userId === currentUser.uid;
                        if (!isMyMessage) {
                            const textElement = messageElement.querySelector('.scrambling-text');
                            textElement.textContent = msg.data.text;
                        } else {
                            const tempId = Array.from(chatMessages.children).find(el => el.id.startsWith('temp-'))?.id;
                            const tempElem = tempId ? document.getElementById(tempId) : null;
                            if (tempElem) tempElem.remove();
                        }
                        
                        chatMessages.appendChild(messageElement);
                    }
                });
                scrollToBottom();
            });
        }
        
        function listenForOnlineUsers() {
            const q = query(collection(db, `/artifacts/${appId}/public/data/presence`));
            onSnapshot(q, (snapshot) => {
                const count = snapshot.size;
                onlineCountEl.textContent = `${count} Member${count !== 1 ? 's' : ''} Online`;
            });
        }

        // --- Start everything ---
        initApp();
    </script>
</body>
</html>
